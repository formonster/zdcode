#!/usr/bin/env node
import{Command as Y}from"commander";import E from"chalk";import{getProjectJsonFile as K}from"@zdcode/utils";import F from"inquirer";async function g(t,o){let{action:e}=await F.prompt([{name:"action",type:"list",message:t,choices:o.map(r=>typeof r=="string"?{name:r,value:r}:r)}]);return e}var z=async t=>{let{action:o}=await F.prompt([{name:"action",type:"input",message:t}]);return o},L=async(t,o)=>{let{action:e}=await F.prompt([{name:"action",type:"confirm",message:t,default:o}]);return e};import G from"fs";import D from"path";import u from"chalk";import{writeFile as H,getProjectFile as k}from"@zdcode/utils";import{humpToChain as I,lowerFirstLetter as M,upperFirstLetter as Z}from"@zdcode/utils";var R={F:Z,f:M,"-":I},T=(t,o,e)=>t.replace(new RegExp(o.replace("$","\\$").replace("{","\\{").replace("}","\\}").replace("|","\\|"),"g"),e),y=(t,o)=>{let e=t.match(/(\$T\{)([A-Za-z|_|:|-])+(\})/g);return e&&(e=Array.from(new Set(e)),e.map(i=>{let c=i.slice(3).slice(0,-1).split("|");return{content:i,formats:c.slice(0,-1),name:c.slice(-1)[0]}}).forEach(({content:i,formats:c,name:p})=>{let s=o[p];if(!s)return;let n=s;for(let a of c)R[a]&&(n=R[a](n));t=T(t,i,n)})),t};var b=async(t,o,e)=>{for(let r of o){let i=r.root,c=r.name&&y(r.name,e),p=[t,i,c].filter(Boolean).join("/").replace(/\/\//g,"/");if(r.files){await b(p,r.files,e);continue}if(r.type==="replace"){let{replaceFile:s,replaceOptions:n}=r;if(!s||!n)continue;let a=D.join(p,s),l=k(a);for(let d of n){let{target:m,template:w,content:v}=d;if(!m)throw new Error("\u8BF7\u6307\u5B9A\u8981\u66FF\u6362\u5185\u5BB9\u7684\u6587\u4EF6\u8DEF\u5F84\uFF01");if(!w&&!v)throw new Error("\u8BF7\u6307\u5B9A\u8981\u66FF\u6362\u7684\u5185\u5BB9\uFF01");let x=k(`.templates/${w}`),f=y(m,e),J=T(l,`// $T{${f}}`,`// $T{${f}}
${y(x,e)}`);G.writeFileSync(a,J,"utf8")}console.log("\u{1F389}",u.blue("replace"),u.gray(a))}if(r.template){let s=r.template,n=k(`.templates/${s}`),a=y(n,e);await H(D.resolve(process.cwd(),p),a),console.log("\u{1F389}",u.blue("create "),u.gray(p))}}};var Q=t=>{t.command("template").description("\u5FEB\u901F\u521B\u5EFA\u6A21\u677F\u6587\u4EF6").action(async()=>{let o=K(".templates/template.json"),e=await g("\u8BF7\u9009\u62E9\u6A21\u677F",o.map(({name:n})=>({name:n,value:n}))),r=o.find(({name:n})=>n===e);if(!r)throw new Error("\u6A21\u677F\u5F02\u5E38\uFF01");let{params:i=[],root:c,templates:p}=r,s={};if(i.length)for(let n of i){if(typeof n=="string"){let a=await z(`\u8BF7\u8F93\u5165 ${n}:`);s[n]=a}if(Array.isArray(n)){let[a,l]=n;if(typeof l=="string"&&l==="boolean"){let m=await L(`${a}?`);s[a]=m}if(Array.isArray(l)){let d=l,m=await g(`\u8BF7\u9009\u62E9 ${a}`,d.map(w=>({name:w,value:w})));s[a]=m}}}console.log(""),console.log("\u{1F433}",E.gray("\u5F00\u59CB\u751F\u6210\u6A21\u677F\u6587\u4EF6")),console.log(""),await b(c,p,s),console.log(""),console.log("\u{1F433}",E.green("success!")),console.log("")})},j=Q;import U from"path";import C from"chalk";import V from"fs";import{list as O,responseError as _}from"@zdcode/superdb";import{arr2Dic as B}from"@zdcode/utils";import"zx/globals";var P=async(t,o,e)=>{let r=process.cwd(),i=`${t}/${o}`;console.log(""),console.log("\u{1F433}",chalk.gray("\u60A8\u7684\u9879\u76EE\u8DEF\u5F84\u4E3A:"),chalk.yellow(i)),console.log(""),await cd(t),await $`git clone -b ${e.branch} ${e.git_url} ${o}`,await $`rm -rf ${i}/.git`,e.whether_init_git&&(await $`git init`,await $`git add .`,await $`git commit -m first commit`,await $`git branch -M main`),await cd(r)};async function A(t){let o=process.cwd(),e=await g("\u8BF7\u4F60\u9009\u62E9\u5305\u7BA1\u7406\u5DE5\u5177:",["pnpm","yarn","npm"]);await cd(t),await $`pwd`;try{await $`${e} install`}catch{}await cd(o),console.log(`
\u{1F433}`,chalk.yellowBright(t),chalk.green("\u521D\u59CB\u5316\u5B8C\u6210")),console.log(`
\u{1F433}`,chalk.yellowBright("$"),chalk.gray(`cd ${t}`)),console.log("\u{1F433}",chalk.yellowBright("$"),chalk.gray("yarn dev")),console.log()}var W=t=>{t.command("create <project-name>").description("\u5FEB\u901F\u521B\u5EFA\u811A\u624B\u67B6").action(async(o,e)=>{let r=e.cwd||process.cwd(),i=U.resolve(r,o||".");V.existsSync(i)&&(console.log("\u274C",C.red("\u76EE\u5F55\u5DF2\u5B58\u5728\uFF01")),process.exit(1)),console.log(""),console.log("\u{1F433}",C.gray("\u60A8\u7684\u9879\u76EE\u540D:"),C.yellow(o)),console.log("");let c=await O("frame_type");if(_(c))throw new Error("\u67E5\u8BE2\u811A\u624B\u67B6\u7C7B\u578B\u5931\u8D25\uFF01");let p=c.data||[],s=B(p,"name"),n=await g("\u8BF7\u9009\u62E9\u6A21\u677F",p.map(({name:f})=>({name:f,value:f}))),a=s[n],l=await O("frames",{where:{type:a.id}});if(_(l))throw new Error("\u67E5\u8BE2\u811A\u624B\u67B6\u5217\u8868\u5931\u8D25\uFF01");let d=l.data||[],m=B(d,"name"),w=await g("\u8BF7\u9009\u62E9\u811A\u624B\u67B6",d.map(({name:f})=>({name:f,value:f}))),v=m[w],x=`${a.root}/${o}`;await P(a.root,o,v),await A(x)})},S=W;var q={name:"@zdcode/cli",version:"2.2.4",description:"",type:"module",main:"dist/index.js",types:"dist/index.d.ts",scripts:{dev:"tsup --watch",prepublish:"pnpm run build",build:"tsup"},keywords:[],author:"",license:"ISC",bin:{zdcode:"./dist/index.js",zd:"./dist/index.js"},files:["dist"],publishConfig:{registry:"http://43.143.167.128:4000/"},dependencies:{"@zdcode/superdb":"workspace:^1.0.1","@zdcode/tsconfig":"workspace:^1.0.0","@zdcode/utils":"workspace:^2.1.1",chalk:"^5.2.0",commander:"^9.4.1",inquirer:"^9.1.4",lodash:"^4.17.21",tsconfig:"^7.0.0",tsup:"^6.5.0",zx:"^7.1.1"},devDependencies:{"@types/inquirer":"^9.0.3","@types/lodash":"^4.14.191","@types/node":"^18.11.12",typescript:"^4.9.4"}};var h=new Y;j(h);S(h);h.version(q.version,"-v, --version","output the current version");h.parse(process.argv);
